{% extends 'base.html' %}
{% load static %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    #map-container {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
    #map {
        height: 100%;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div id="map-container">
    <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script>
    // تنظیم مسیر آیکون‌ها
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconRetinaUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png',
        iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png'
    });

    // ایجاد نقشه با تمام اصلاحات ضروری
    document.addEventListener('DOMContentLoaded', function() {
        const map = L.map('map', {
            preferCanvas: true,  // کاهش مشکل تکه‌تکه شدن
            zoomControl: true    // فعال کردن کنترل zoom
        }).setView([35.6892, 51.3890], 13);
        
        const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            noWrap: true,       // جلوگیری از تکثیر نقشه
            updateWhenIdle: true // بهینه‌سازی رندر
        }).addTo(map);

        // اضافه کردن نشانگر
        const marker = L.marker([35.6892, 51.3890], {
            title: 'تهران',
            alt: 'نشانگر تهران',
            riseOnHover: true
        }).addTo(map)
          .bindPopup('تهران، ایران')
          .openPopup();

        // رفع نهایی مشکل تکه‌تکه شدن
        setTimeout(() => {
            map.invalidateSize({animate: true});
            map.setView([35.6892, 51.3890], 13, {animate: true});
        }, 200);

        // رفع مشکل هنگام تغییر سایز پنجره
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });
    });
</script>
{% endblock %}